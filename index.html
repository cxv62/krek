<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Kraken Lyrics مع تجديد توكن تلقائي</title>
  <style>
    body {
      margin:0;
      background:#000;
      color:#fff;
      font-family: Verdana, Arial, sans-serif;
      display:flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      text-align: center;
    }
    #cover {
      width: 100%;
      max-width: 240px;
      aspect-ratio: 1/1;
      object-fit: cover;
      border-radius: 10px;
      margin-top: 8px;
    }
    #lyricsBox {
      flex: 1;
      width: 90%;
      overflow: hidden;
      position: relative;
      margin-top: 6px;
    }
    #lyrics {
      position: absolute;
      top: 100%;
      width: 100%;
      line-height: 1.3em;
      text-align: center;
      white-space: pre-wrap;
    }
    button {
      margin-top: 15px;
      padding: 8px 16px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      background: #1DB954;
      color: #fff;
      cursor: pointer;
    }
    #loginMsg {
      margin-top: 15px;
      font-size: 14px;
      color: #bbb;
    }
  </style>
</head>
<body>

  <img id="cover" src="" alt="Cover" />
  <div id="lyricsBox"><div id="lyrics">جاري تحميل الكلمات...</div></div>

  <button id="loginBtn" style="display:none;">تسجيل دخول Spotify</button>
  <div id="loginMsg"></div>

  <script src="https://cdn.jsdelivr.net/npm/lyrics-finder/dist/lyrics-finder.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/spotify-web-api-js"></script>

  <script>
    const CLIENT_ID = 'c29a0ebbef824fada858c8d774de217b';
    const REDIRECT_URI = 'https://cxv62.github.io/krek/';  // عدل حسب رابط GitHub Pages عندك
    const SCOPES = 'user-read-playback-state';

    const spotify = new SpotifyWebApi();

    const cover = document.getElementById('cover');
    const lyricsDiv = document.getElementById('lyrics');
    const loginBtn = document.getElementById('loginBtn');
    const loginMsg = document.getElementById('loginMsg');

    // تفحص إذا في access_token في URL
    function getAccessTokenFromUrl() {
      const params = new URLSearchParams(window.location.hash.substring(1));
      return params.get('access_token');
    }

    // تخزين التوكن في localStorage
    function storeToken(token) {
      localStorage.setItem('spotify_access_token', token);
      localStorage.setItem('spotify_token_timestamp', Date.now());
    }

    // جلب التوكن من التخزين المحلي لو موجود ولم ينتهِ صلاحيته (ساعة)
    function getStoredToken() {
      const token = localStorage.getItem('spotify_access_token');
      const timestamp = localStorage.getItem('spotify_token_timestamp');
      if (!token || !timestamp) return null;
      if (Date.now() - timestamp > 3600 * 1000) return null; // انتهاء صلاحية
      return token;
    }

    // توكن جديد من URL أو من التخزين
    let accessToken = getAccessTokenFromUrl() || getStoredToken();

    if (!accessToken) {
      // نعرض زر تسجيل الدخول
      loginBtn.style.display = 'inline-block';
      loginMsg.textContent = 'اضغط هنا لتسجيل الدخول إلى Spotify';

      loginBtn.addEventListener('click', () => {
        const authUrl = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}`;
        window.location.href = authUrl;
      });
    } else {
      // خزّن التوكن الجديد وحدث الصفحة
      storeToken(accessToken);
      loginBtn.style.display = 'none';
      loginMsg.textContent = '';

      spotify.setAccessToken(accessToken);

      let currentTrackId = '';

      async function fetchLyrics(artist, title) {
        const lyrics = await lyricsFinder(artist, title);
        return lyrics || 'لم يتم العثور على كلمات.';
      }

      function scrollLyrics(duration) {
        const totalHeight = lyricsDiv.scrollHeight + 40;
        lyricsDiv.animate(
          [{ top: '100%' }, { top: `-${totalHeight}px` }],
          {
            duration: duration,
            easing: 'linear',
            fill: 'forwards'
          }
        );
      }

      async function updateDisplay() {
        try {
          const data = await spotify.getMyCurrentPlaybackState();
          if (!data || !data.item) {
            lyricsDiv.innerText = 'لا توجد أغنية مشغلة حالياً.';
            cover.src = '';
            return;
          }

          const { id, name: title, artists, album, duration_ms } = data.item;
          if (id === currentTrackId) return;

          currentTrackId = id;
          cover.src = album.images[0].url;
          const artistName = artists[0].name;

          lyricsDiv.style.top = '100%';
          lyricsDiv.innerText = await fetchLyrics(artistName, title);
          setTimeout(() => scrollLyrics(duration_ms), 800);
        } catch (err) {
          lyricsDiv.innerText = 'حدث خطأ أثناء جلب البيانات.';
          console.error(err);
        }
      }

      setInterval(updateDisplay, 5000);
      updateDisplay();
    }
  </script>

</body>
</html>
