<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Kraken Lyrics</title>
<style>
  body { margin:0; background:#000; color:#fff; font-family:Tahoma,Verdana; display:flex; flex-direction:column; align-items:center; height:100vh; overflow:hidden; }
  #cover { width:90%; max-width:240px; aspect-ratio:1/1; object-fit:cover; border-radius:8px; margin:8px auto 4px; }
  #info { text-align:center; margin-bottom:4px; }
  #lyricsBox { flex:1; width:90%; overflow:hidden; position:relative; }
  #lyrics { position:absolute; top:100%; width:100%; line-height:1.3em; text-align:center; white-space:pre-wrap; }
</style>
</head>
<body>
<img id="cover" src="">
<div id="info">جاري التوصيل...</div>
<div id="lyricsBox"><div id="lyrics">Loading...</div></div>

<script src="https://cdn.jsdelivr.net/npm/spotify-web-api-js@1.5.1"></script>
<script src="https://cdn.jsdelivr.net/npm/lyrics-finder/dist/lyrics-finder.min.js"></script>

<script>
// ---- إعداداتك ----
const CLIENT_ID = 'adb874df60704c168b65a2d80042d8f0';
const REDIRECT_URI = 'https://cxv62.github.io/kraken-lyrics/';
const SCOPES = 'user-read-playback-state';
// Genius: سيتم استخدام lyrics-finder (لا يحتاج Token)
// --------------------

const spotify = new SpotifyWebApi();
const cover = document.getElementById('cover');
const info = document.getElementById('info');
const lyricsDiv = document.getElementById('lyrics');
let currentId = '';
let accessToken = '';

// خلق PKCE (رمز تحدي) لهجوم -->
function createRandomString(length) { const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'; let str=''; for(let i=0;i<length;i++) str += chars.charAt(Math.floor(Math.random()*chars.length)); return str; }
function base64urlencode(str) {
  return btoa(String.fromCharCode.apply(null,new Uint8Array(str)))
    .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
async function sha256(buffer) { return crypto.subtle.digest('SHA-256', new TextEncoder().encode(buffer)); }

async function startAuth() {
  const codeVerifier = createRandomString(128);
  const challenge = base64urlencode(await sha256(codeVerifier));
  localStorage.setItem('verifier', codeVerifier);
  const url = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}` +
    `&response_type=code&redirect_uri=${encodeURIComponent(REDIRECT_URI)}` +
    `&scope=${encodeURIComponent(SCOPES)}` +
    `&code_challenge_method=S256&code_challenge=${challenge}`;
  window.location = url;
}

async function handleRedirect() {
  const params = new URLSearchParams(window.location.search);
  if (!params.get('code')) return false;
  const code = params.get('code');
  const verifier = localStorage.getItem('verifier');
  
  const resp = await fetch('https://accounts.spotify.com/api/token', {
    method: 'POST',
    headers: {'Content-Type':'application/x-www-form-urlencoded'},
    body: new URLSearchParams({
      client_id: CLIENT_ID,
      grant_type: 'authorization_code',
      code: code,
      redirect_uri: REDIRECT_URI,
      code_verifier: verifier
    })
  });
  const data = await resp.json();
  accessToken = data.access_token;
  localStorage.setItem('sp_token', accessToken);
  window.history.replaceState({}, null, '/');
  return true;
}

async function refreshToken() {
  const token = localStorage.getItem('sp_token');
  if (token) accessToken = token;
}

async function fetchAndDisplay() {
  if (!accessToken) return;
  spotify.setAccessToken(accessToken);
  try {
    const playback = await spotify.getMyCurrentPlaybackState();
    if (!playback?.item) return;
    const track = playback.item;
    if (track.id === currentId) return;
    currentId = track.id;
    
    cover.src = track.album.images[0].url;
    info.innerText = `${track.name} — ${track.artists[0].name}`;
    
    const txt = await lyricsFinder(track.artists[0].name, track.name) || 'Lyrics not found.';
    lyricsDiv.style.top = '100%';
    lyricsDiv.innerText = txt;
    
    const duration = playback.item.duration_ms;
    lyricsDiv.animate([{ top:'100%' },{ top:`-${lyricsDiv.scrollHeight}px`}], { duration: duration, easing:'linear', fill:'forwards' });
  } catch(e) {
    console.error(e);
  }
}

(async () => {
  await refreshToken();
  const authComplete = await handleRedirect();
  if (!accessToken && !authComplete) {
    await startAuth();
  } else {
    if (!accessToken) await refreshToken();
    fetchAndDisplay();
    setInterval(fetchAndDisplay, 5000);
  }
})();
</script>

</body>
</html>
